<div class="mantenimientos-container">
  <!-- Tarjetas de estadísticas -->
  <div class="stats-grid">
    <mat-card class="stat-card total">
      <div class="stat-content">
        <mat-icon class="stat-icon">build</mat-icon>
        <div class="stat-info">
          <h3>{{ estadisticas.total }}</h3>
          <p>Total Mantenimientos</p>
        </div>
      </div>
    </mat-card>

    <mat-card class="stat-card programados">
      <div class="stat-content">
        <mat-icon class="stat-icon">schedule</mat-icon>
        <div class="stat-info">
          <h3>{{ estadisticas.programados }}</h3>
          <p>Programados</p>
        </div>
      </div>
    </mat-card>

    <mat-card class="stat-card en-proceso">
      <div class="stat-content">
        <mat-icon class="stat-icon">play_circle</mat-icon>
        <div class="stat-info">
          <h3>{{ estadisticas.enProceso }}</h3>
          <p>En Proceso</p>
        </div>
      </div>
    </mat-card>

    <mat-card class="stat-card completados">
      <div class="stat-content">
        <mat-icon class="stat-icon">check_circle</mat-icon>
        <div class="stat-info">
          <h3>{{ estadisticas.completados }}</h3>
          <p>Completados</p>
        </div>
      </div>
    </mat-card>

    <mat-card class="stat-card cancelados">
      <div class="stat-content">
        <mat-icon class="stat-icon">cancel</mat-icon>
        <div class="stat-info">
          <h3>{{ estadisticas.cancelados }}</h3>
          <p>Cancelados</p>
        </div>
      </div>
    </mat-card>
  </div>

  <!-- Pestañas por estado -->
  <mat-card class="main-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>build</mat-icon>
        Gestión de Mantenimientos
      </mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <!-- Barra de herramientas -->
      <div class="toolbar">
        <div class="search-section">
          <mat-form-field appearance="outline">
            <mat-label>Buscar mantenimientos</mat-label>
            <input matInput [(ngModel)]="searchTerm" (input)="applyFilter()" placeholder="Vehículo, cliente, tipo o estado">
            <mat-icon matSuffix>search</mat-icon>
            <button mat-icon-button matSuffix *ngIf="searchTerm" (click)="clearSearch()" matTooltip="Limpiar búsqueda">
              <mat-icon>clear</mat-icon>
            </button>
          </mat-form-field>
          
          <!-- Indicador de búsqueda -->
          <div *ngIf="isSearching" class="search-indicator">
            <mat-spinner diameter="20"></mat-spinner>
            <span>Buscando...</span>
          </div>
        </div>
        
        <div class="actions-section">
          <button mat-raised-button color="primary" (click)="openDialog()">
            <mat-icon>add</mat-icon>
            Nuevo Mantenimiento
          </button>
        </div>
      </div>

      <!-- Pestañas -->
      <mat-tab-group (selectedTabChange)="onTabChange($event)">
        <mat-tab label="Todos ({{ estadisticas.total }})">
          <div class="tab-content">
            <div class="table-container">
              <table mat-table [dataSource]="dataSource" matSort class="mantenimientos-table">
                
                <!-- Columna Vehículo -->
                <ng-container matColumnDef="vehiculo">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Vehículo </th>
                  <td mat-cell *matCellDef="let mantenimiento">
                    <div class="vehiculo-info">
                      <div class="vehiculo-placa">{{ mantenimiento.vehiculoPlaca }}</div>
                      <div class="vehiculo-details">{{ mantenimiento.vehiculoMarca }} {{ mantenimiento.vehiculoModelo }}</div>
                      <div class="cliente-info">{{ mantenimiento.clienteNombre }}</div>
                    </div>
                  </td>
                </ng-container>

                <!-- Columna Tipo de Mantenimiento -->
                <ng-container matColumnDef="tipoMantenimiento">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Tipo </th>
                  <td mat-cell *matCellDef="let mantenimiento"> {{ mantenimiento.tipoMantenimiento }} </td>
                </ng-container>

                <!-- Columna Fecha Programada -->
                <ng-container matColumnDef="fechaProgramada">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha Programada </th>
                  <td mat-cell *matCellDef="let mantenimiento"> {{ formatDate(mantenimiento.fechaProgramada) }} </td>
                </ng-container>

                <!-- Columna Fecha Completado -->
                <ng-container matColumnDef="fechaCompletado">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha Completado </th>
                  <td mat-cell *matCellDef="let mantenimiento"> 
                    {{ mantenimiento.estado === 'COMPLETADO' && mantenimiento.fechaFin ? formatDate(mantenimiento.fechaFin) : '-' }} 
                  </td>
                </ng-container>

                <!-- Columna Estado -->
                <ng-container matColumnDef="estado">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Estado </th>
                  <td mat-cell *matCellDef="let mantenimiento">
                    <mat-chip [color]="getEstadoColor(mantenimiento.estado)" selected>
                      {{ mantenimiento.estado }}
                    </mat-chip>
                  </td>
                </ng-container>

                <!-- Columna Mecánico -->
                <ng-container matColumnDef="mecanico">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Mecánico </th>
                  <td mat-cell *matCellDef="let mantenimiento"> 
                    {{ mantenimiento.mecanico || '-' }} 
                  </td>
                </ng-container>

                <!-- Columna Costo -->
                <ng-container matColumnDef="costo">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Costo </th>
                  <td mat-cell *matCellDef="let mantenimiento"> 
                    {{ mantenimiento.costo ? '$' + (mantenimiento.costo | number:'1.0-0') : '-' }} 
                  </td>
                </ng-container>

                <!-- Columna Acciones -->
                <ng-container matColumnDef="acciones">
                  <th mat-header-cell *matHeaderCellDef> Acciones </th>
                  <td mat-cell *matCellDef="let mantenimiento">
                    <div class="action-buttons">
                      <button mat-icon-button color="primary" (click)="openDialog(mantenimiento)" matTooltip="Editar">
                        <mat-icon>edit</mat-icon>
                      </button>
                      
                      <button mat-icon-button color="accent" 
                              (click)="iniciarMantenimiento(mantenimiento)" 
                              [disabled]="!canIniciar(mantenimiento.estado)"
                              matTooltip="Iniciar Mantenimiento">
                        <mat-icon>play_arrow</mat-icon>
                      </button>
                      
                      <button mat-icon-button color="primary" 
                              (click)="completarMantenimiento(mantenimiento)" 
                              [disabled]="!canCompletar(mantenimiento.estado)"
                              matTooltip="Completar Mantenimiento">
                        <mat-icon>check</mat-icon>
                      </button>
                      
                      <button mat-icon-button color="warn" 
                              (click)="cancelarMantenimiento(mantenimiento)" 
                              [disabled]="!canCancelar(mantenimiento.estado)"
                              matTooltip="Cancelar Mantenimiento">
                        <mat-icon>cancel</mat-icon>
                      </button>
                      
                      <button mat-icon-button color="warn" (click)="deleteMantenimiento(mantenimiento)" matTooltip="Eliminar">
                        <mat-icon>delete</mat-icon>
                      </button>
                    </div>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
              </table>

              <mat-paginator 
                [pageSizeOptions]="[5, 10, 25, 50]" 
                showFirstLastButtons>
              </mat-paginator>
            </div>
          </div>
        </mat-tab>

        <mat-tab label="Programados ({{ mantenimientosProgramadosFiltrados.length }})">
          <div class="tab-content">
            <div class="mantenimientos-grid">
              <mat-card *ngFor="let mantenimiento of mantenimientosProgramadosFiltrados" class="mantenimiento-card programado">
                <mat-card-header>
                  <mat-card-title>{{ mantenimiento.tipoMantenimiento }}</mat-card-title>
                  <mat-card-subtitle>{{ mantenimiento.vehiculoPlaca }} - {{ mantenimiento.clienteNombre }}</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                  <p><strong>Fecha:</strong> {{ formatDate(mantenimiento.fechaProgramada) }}</p>
                  <p><strong>Mecánico:</strong> {{ mantenimiento.mecanico || 'No asignado' }}</p>
                  <p><strong>Costo:</strong> {{ mantenimiento.costo ? '$' + (mantenimiento.costo | number:'1.0-0') : 'No definido' }}</p>
                  <p *ngIf="mantenimiento.descripcion"><strong>Descripción:</strong> {{ mantenimiento.descripcion }}</p>
                </mat-card-content>
                <mat-card-actions>
                  <button mat-button color="accent" (click)="iniciarMantenimiento(mantenimiento)">
                    <mat-icon>play_arrow</mat-icon> Iniciar
                  </button>
                  <button mat-button color="primary" (click)="openDialog(mantenimiento)">
                    <mat-icon>edit</mat-icon> Editar
                  </button>
                </mat-card-actions>
              </mat-card>
            </div>
          </div>
        </mat-tab>

        <mat-tab label="En Proceso ({{ mantenimientosEnProcesoFiltrados.length }})">
          <div class="tab-content">
            <div class="mantenimientos-grid">
              <mat-card *ngFor="let mantenimiento of mantenimientosEnProcesoFiltrados" class="mantenimiento-card en-proceso">
                <mat-card-header>
                  <mat-card-title>{{ mantenimiento.tipoMantenimiento }}</mat-card-title>
                  <mat-card-subtitle>{{ mantenimiento.vehiculoPlaca }} - {{ mantenimiento.clienteNombre }}</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                  <p><strong>Iniciado:</strong> {{ formatDate(mantenimiento.fechaInicio) }}</p>
                  <p><strong>Mecánico:</strong> {{ mantenimiento.mecanico || 'No asignado' }}</p>
                  <p><strong>Costo:</strong> {{ mantenimiento.costo ? '$' + (mantenimiento.costo | number:'1.0-0') : 'No definido' }}</p>
                  <p *ngIf="mantenimiento.observaciones"><strong>Observaciones:</strong> {{ mantenimiento.observaciones }}</p>
                </mat-card-content>
                <mat-card-actions>
                  <button mat-button color="primary" (click)="completarMantenimiento(mantenimiento)">
                    <mat-icon>check</mat-icon> Completar
                  </button>
                  <button mat-button color="warn" (click)="cancelarMantenimiento(mantenimiento)">
                    <mat-icon>cancel</mat-icon> Cancelar
                  </button>
                </mat-card-actions>
              </mat-card>
            </div>
          </div>
        </mat-tab>

        <mat-tab label="Completados ({{ mantenimientosCompletadosFiltrados.length }})">
          <div class="tab-content">
            <div class="mantenimientos-grid">
              <mat-card *ngFor="let mantenimiento of mantenimientosCompletadosFiltrados" class="mantenimiento-card completado">
                <mat-card-header>
                  <mat-card-title>{{ mantenimiento.tipoMantenimiento }}</mat-card-title>
                  <mat-card-subtitle>{{ mantenimiento.vehiculoPlaca }} - {{ mantenimiento.clienteNombre }}</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                  <p><strong>Completado:</strong> {{ formatDate(mantenimiento.fechaFin) }}</p>
                  <p><strong>Mecánico:</strong> {{ mantenimiento.mecanico || 'No asignado' }}</p>
                  <p><strong>Costo:</strong> {{ mantenimiento.costo ? '$' + (mantenimiento.costo | number:'1.0-0') : 'No definido' }}</p>
                  <p *ngIf="mantenimiento.observaciones"><strong>Observaciones:</strong> {{ mantenimiento.observaciones }}</p>
                </mat-card-content>
                <mat-card-actions>
                  <button mat-button color="primary" (click)="openDialog(mantenimiento)">
                    <mat-icon>visibility</mat-icon> Ver Detalles
                  </button>
                </mat-card-actions>
              </mat-card>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>

  <!-- Diálogo para crear/editar mantenimiento -->
  <div class="dialog-overlay" *ngIf="showDialog" (click)="closeDialog()"></div>
  
  <div class="dialog-container" *ngIf="showDialog">
    <mat-card class="dialog-card">
      <mat-card-header>
        <mat-card-title>
          {{ isEditing ? 'Editar Mantenimiento' : 'Nuevo Mantenimiento' }}
        </mat-card-title>
      </mat-card-header>
      
      <mat-card-content>
        <form [formGroup]="mantenimientoForm" (ngSubmit)="saveMantenimiento()">
          
          <!-- SECCIÓN 1: INFORMACIÓN BÁSICA -->
          <div class="form-section">
            <h3 class="section-title">Información Básica</h3>
            
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Buscar Vehículo *</mat-label>
                <input matInput 
                       formControlName="vehiculoSearch" 
                       placeholder="Buscar por placa, marca, modelo o cliente"
                       [matAutocomplete]="auto">
                <mat-autocomplete #auto="matAutocomplete" 
                                 (optionSelected)="onVehiculoSelected($event.option.value)"
                                 [displayWith]="displayVehiculoFn">
                  <mat-option *ngFor="let vehiculo of filteredVehiculos | async" [value]="vehiculo.id">
                    {{ vehiculo.placa }} - {{ vehiculo.marca }} {{ vehiculo.modelo }} ({{ vehiculo.clienteNombre }})
                  </mat-option>
                </mat-autocomplete>
                <mat-error *ngIf="mantenimientoForm.get('vehiculoSearch')?.hasError('required')">
                  Debe seleccionar un vehículo
                </mat-error>
              </mat-form-field>
              <!-- Campo oculto para el ID del vehículo -->
              <input type="hidden" formControlName="vehiculoId">

              <mat-form-field appearance="outline">
                <mat-label>Tipo de Mantenimiento *</mat-label>
                <mat-select formControlName="tipoMantenimiento">
                  <mat-option *ngFor="let tipo of tiposMantenimiento" [value]="tipo">
                    {{ tipo }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="mantenimientoForm.get('tipoMantenimiento')?.hasError('required')">
                  {{ getErrorMessage('tipoMantenimiento') }}
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Fecha Programada *</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="fechaProgramada" (dateChange)="onFechaProgramadaChange($event)">
                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
                <mat-error *ngIf="mantenimientoForm.get('fechaProgramada')?.hasError('required')">
                  {{ getErrorMessage('fechaProgramada') }}
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Estado *</mat-label>
                <mat-select formControlName="estado">
                  <mat-option *ngFor="let estado of estados" [value]="estado">
                    {{ estado }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="mantenimientoForm.get('estado')?.hasError('required')">
                  {{ getErrorMessage('estado') }}
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Mecánico *</mat-label>
                <input matInput formControlName="mecanico" placeholder="Nombre del mecánico que realizará el servicio">
                <mat-error *ngIf="mantenimientoForm.get('mecanico')?.hasError('required')">
                  Debe especificar el mecánico
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Kilometraje Actual</mat-label>
                <input matInput 
                       formControlName="kilometrajeActual" 
                       placeholder="0" 
                       readonly
                       [value]="selectedVehiculo?.kilometraje || 0">
                <mat-icon matSuffix>speed</mat-icon>
                <mat-error *ngIf="mantenimientoForm.get('kilometrajeActual')?.hasError('min')">
                  {{ getErrorMessage('kilometrajeActual') }}
                </mat-error>
              </mat-form-field>
            </div>
          </div>

          <!-- SECCIÓN 2: COSTOS Y REPUESTOS -->
          <div class="form-section">
            <h3 class="section-title">Costos y Repuestos</h3>
            
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Costo Total</mat-label>
                <input matInput 
                       [value]="costoTotalCalculado" 
                       placeholder="0" 
                       readonly
                       [class.calculated]="true">
                <mat-icon matSuffix>calculate</mat-icon>
                <mat-hint>Suma automática de todos los costos</mat-hint>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Proveedor de Repuestos *</mat-label>
                <mat-select formControlName="proveedorRepuestos" (selectionChange)="onProveedorRepuestosChange($event)">
                  <mat-option value="taller">Taller</mat-option>
                  <mat-option value="cliente">Cliente</mat-option>
                </mat-select>
                <mat-error *ngIf="mantenimientoForm.get('proveedorRepuestos')?.hasError('required')">
                  Debe especificar quién proporciona los repuestos
                </mat-error>
              </mat-form-field>
            </div>

                        <!-- Campos específicos para taller -->
            <div *ngIf="mantenimientoForm.get('proveedorRepuestos')?.value === 'taller'">
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Valor Repuestos</mat-label>
                  <input matInput 
                         formControlName="valorRepuestos" 
                         placeholder="0" 
                         appNumberFormat="currency"
                         [decimalPlaces]="0"
                         [thousandSeparator]="','"
                         [decimalSeparator]="'.'"
                         (input)="onValorRepuestosChange()">
                  <mat-icon matSuffix>build</mat-icon>
                  <mat-error *ngIf="mantenimientoForm.get('valorRepuestos')?.hasError('min')">
                    {{ getErrorMessage('valorRepuestos') }}
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>20% Valor Repuestos</mat-label>
                  <input matInput 
                         [value]="valorRepuestosCalculado" 
                         placeholder="0" 
                         readonly
                         [class.calculated]="true">
                  <mat-icon matSuffix>calculate</mat-icon>
                  <mat-hint>20% del valor de repuestos</mat-hint>
                </mat-form-field>
              </div>
            </div>

            <!-- Campos comunes para ambos proveedores -->
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Costo Mano de Obra</mat-label>
                <input matInput 
                       formControlName="costoManoObra" 
                       placeholder="0" 
                       appNumberFormat="currency"
                       [decimalPlaces]="0"
                       [thousandSeparator]="','"
                       [decimalSeparator]="'.'"
                       (input)="onCostoManoObraChange()">
                <mat-icon matSuffix>engineering</mat-icon>
                <mat-error *ngIf="mantenimientoForm.get('costoManoObra')?.hasError('min')">
                  {{ getErrorMessage('costoManoObra') }}
                </mat-error>
              </mat-form-field>

              <mat-form-field appearance="outline">
                <mat-label>Costo Adicionales</mat-label>
                <input matInput 
                       formControlName="costoAdicionales" 
                       placeholder="0" 
                       appNumberFormat="currency"
                       [decimalPlaces]="0"
                       [thousandSeparator]="','"
                       [decimalSeparator]="'.'"
                       (input)="onCostoAdicionalesChange()">
                <mat-icon matSuffix>add_circle</mat-icon>
                <mat-error *ngIf="mantenimientoForm.get('costoAdicionales')?.hasError('min')">
                  {{ getErrorMessage('costoAdicionales') }}
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Garantía</mat-label>
                <input matInput 
                       formControlName="garantia" 
                       placeholder="Sin garantía"
                       readonly>
                <mat-icon matSuffix>security</mat-icon>
                <mat-error *ngIf="mantenimientoForm.get('garantia')?.hasError('required')">
                  {{ getErrorMessage('garantia') }}
                </mat-error>
              </mat-form-field>
            </div>
          </div>

          <!-- SECCIÓN 3: DESCRIPCIÓN Y OBSERVACIONES -->
          <div class="form-section">
            <h3 class="section-title">Descripción y Observaciones</h3>
            
            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Descripción</mat-label>
                <textarea matInput formControlName="descripcion" placeholder="Descripción del mantenimiento" rows="3"></textarea>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline">
                <mat-label>Observaciones</mat-label>
                <textarea matInput formControlName="observaciones" placeholder="Observaciones adicionales" rows="3"></textarea>
              </mat-form-field>
            </div>
          </div>

          <div class="form-actions">
            <button type="button" mat-button (click)="closeDialog()">Cancelar</button>
            <button type="submit" mat-raised-button color="primary" [disabled]="mantenimientoForm.invalid">
              {{ isEditing ? 'Actualizar' : 'Crear' }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</div> 